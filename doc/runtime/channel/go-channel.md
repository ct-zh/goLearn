# channelå®ç°åˆ†æ

goæœ‰é”æ•°æ®ç»“æ„ï¼ŒCSPæ¦‚å¿µçš„ç»„æˆå› å­ä¹‹ä¸€ã€‚

## æœ€ä½³å®è·µ

åˆ†ä¸ºé˜»å¡å¼chanä¸éé˜»å¡å¼chanï¼› åŒºåˆ«åœ¨äºæœ‰æ— capacityï¼›æ²¡æœ‰çš„è¯channelåªæ˜¯ä¸ªåŒæ­¥é€šä¿¡å·¥å…·ã€‚

#### close chan

- å¯¹äºå·²å…³é—­çš„channelï¼Œå‘é‡Œé¢å‘é€å†…å®¹ä¼španicï¼Œå†æ¬¡å…³é—­ä¼španicï¼›

- closeä¸€ä¸ªchannelä¼šå”¤é†’æ‰€æœ‰ç­‰å¾…è¯¥channelçš„gï¼Œå¹¶ä½¿å…¶è¿›å…¥grunnableçŠ¶æ€ï¼›

- ä½¿ç”¨`for range`åœ¨channelå…³é—­æ—¶ä¼šè‡ªåŠ¨é€€å‡ºå¾ªç¯ï¼›

- å¯ä»¥ä½¿ç”¨lenä¸capå‡½æ•°è·å–channelçš„å…ƒç´ æ•°é‡ä¸bufferå®¹é‡ï¼›

- å¦‚æœchannelä¸­æ²¡æœ‰å€¼ï¼ˆè¿™é‡Œç‰¹æŒ‡buffer channelï¼‰åˆ™å–å€¼ä¼šè¿”å›å¯¹åº”ç±»å‹çš„0å€¼ï¼›åŒºåˆ†æ–¹æ³•æ˜¯`x, ok := <-ch`ï¼›

#### nil chan

  `var a chan int`ä¸ä½¿ç”¨makeæ¥åˆå§‹åŒ–çš„chanæ˜¯nil channelï¼›å…³é—­ä¸€ä¸ªnil channelä¼šå¯¼è‡´panic

#### close principle

  - ä¸€ä¸ªsenderï¼Œå¤šä¸ªreceiverï¼Œç”±senderæ¥å…³é—­chanï¼›
  - å¤šä¸ªsenderï¼Œå¤šä¸ªreceiverï¼Œå€ŸåŠ©å¤–éƒ¨ç¨‹åºæ¥åšä¿¡å·å¹¿æ’­ï¼Œç±»ä¼¼äºdone chanï¼›
  - å¦‚æœç¡®å®šä¸ä¼šæœ‰goroutineåœ¨é€šä¿¡è¿‡ç¨‹ä¸­è¢«é˜»å¡ï¼Œä¹Ÿå¯ä»¥ä¸å…³é—­chanï¼Œç­‰å¾…GC

  > [å¦‚ä½•å…³é—­channel](https://github.com/ct-zh/goLearn/blob/master/doc/runtime/channel/closeChan/closeChan.go)

## ç›¸å…³æ¦‚å¿µ

#### æ— é”ç®¡é“

é”æ˜¯ä¸€ç§å¸¸è§çš„å¹¶å‘æ§åˆ¶æŠ€æœ¯ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šå°†é”åˆ†æˆä¹è§‚é”å’Œæ‚²è§‚é”ï¼Œæ— é”ï¼ˆlock-freeï¼‰é˜Ÿåˆ—æ›´å‡†ç¡®çš„æè¿°æ˜¯ä½¿ç”¨ä¹è§‚å¹¶å‘æ§åˆ¶çš„é˜Ÿåˆ—ã€‚ä¹è§‚å¹¶å‘æ§åˆ¶ä¹Ÿå«ä¹è§‚é”ï¼Œå¾ˆå¤šäººéƒ½ä¼šè¯¯ä»¥ä¸ºä¹è§‚é”æ˜¯ä¸æ‚²è§‚é”å·®ä¸å¤šï¼Œç„¶è€Œå®ƒå¹¶ä¸æ˜¯çœŸæ­£çš„é”ï¼Œåªæ˜¯ä¸€ç§å¹¶å‘æ§åˆ¶çš„æ€æƒ³ã€‚

ä¹è§‚å¹¶å‘æ§åˆ¶æœ¬è´¨ä¸Šæ˜¯åŸºäºéªŒè¯çš„åè®®ï¼Œæˆ‘ä»¬ä½¿ç”¨åŸå­æŒ‡ä»¤ CASï¼ˆcompare-and-swap æˆ–è€… compare-and-setï¼‰åœ¨å¤šçº¿ç¨‹ä¸­åŒæ­¥æ•°æ®ï¼Œæ— é”é˜Ÿåˆ—çš„å®ç°ä¹Ÿä¾èµ–è¿™ä¸€åŸå­æŒ‡ä»¤ã€‚

Channelå«æœ‰ç”¨äºä¿æŠ¤æˆå‘˜å˜é‡çš„äº’æ–¥é”,ç„¶è€Œé”å¯¼è‡´çš„ä¼‘çœ å’Œå”¤é†’ä¼šå¸¦æ¥é¢å¤–çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¦‚æœä¸´ç•ŒåŒºè¿‡å¤§ï¼ŒåŠ é”è§£é”å¯¼è‡´çš„é¢å¤–å¼€é”€å°±ä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚

> ä¸´ç•Œèµ„æºï¼šä¸€æ¬¡ä»…å…è®¸ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨çš„å…±äº«èµ„æºã€‚å¤šä¸ªè¿›ç¨‹å¿…é¡»äº’æ–¥åœ°è®¿é—®ã€‚
>
> ä¸´ç•ŒåŒºï¼šè®¿é—®ä¸´ç•Œèµ„æºçš„ä»£ç ã€‚

ç¤¾åŒºåœ¨2014å¹´æå‡ºäº†æ— é”çš„Channelå®ç°æ–¹æ¡ˆï¼Œè¯¥æ–¹æ¡ˆå°†Channelåˆ†æˆä¸‰ä¸ªç±»å‹ï¼š

- åŒæ­¥channel - ç›´æ¥ä¼ é€’æ•°æ®ï¼›
- å¼‚æ­¥channel - åŸºäºç¯å½¢ç¼“å­˜çš„ä¼ ç»Ÿç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼›
- `chan struct{}` ç±»å‹çš„å¼‚æ­¥channel - ä¸éœ€è¦å®ç°ç¼“å†²åŒºå’Œç›´æ¥å‘é€çš„è¯­ä¹‰ã€‚


## æºç åˆ†æ
> [è¿™ä¸ªäººå†™å¾—å¤ªå¥½äº†ï¼Œæˆ‘å°±ä¸åšé‡å¤å·¥ä½œäº†ğŸ˜Š](https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-channel/#642-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84)

### é‡ç‚¹æ ‡è®°

- buf chanæ˜¯é€šè¿‡å¾ªç¯é˜Ÿåˆ—æ¥å®ç°çš„ï¼Œé€šè¿‡è¯»æŒ‡é’ˆä¸å†™æŒ‡é’ˆæ¥è·å–æ•°æ®ï¼›
- ç¼“å†²åŒºç©ºé—´ä¸è¶³æ—¶gä¼šæŒ‚åœ¨`sendq`æˆ–è€…`recvq`ä¸¤ä¸ªé˜Ÿåˆ—ä¸‹ï¼Œæ­¤æ—¶gä¼šè¢«æ‰“åŒ…æˆ`sudog`
- sudog - å½“ g é‡åˆ°é˜»å¡ï¼Œæˆ–éœ€è¦ç­‰å¾…çš„åœºæ™¯æ—¶ï¼Œä¼šè¢«æ‰“åŒ…æˆ sudog è¿™æ ·ä¸€ä¸ªç»“æ„ã€‚ä¸€ä¸ª g å¯èƒ½è¢«æ‰“åŒ…ä¸ºå¤šä¸ª sudog åˆ†åˆ«æŒ‚åœ¨ä¸åŒçš„ç­‰å¾…é˜Ÿåˆ—ä¸Š;

## Reference

- [Goè¯­è¨€Channelçš„å®ç°åŸç†](https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-channel/#fn:6)
- [ä¸´ç•ŒåŒº](https://baike.baidu.com/item/%E4%B8%B4%E7%95%8C%E5%8C%BA/8942134?fr=aladdin)
- 